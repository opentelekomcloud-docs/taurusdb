:original_name: gaussdb_05_2265.html

.. _gaussdb_05_2265:

Upgrading the Minor Version of a DB Instance
============================================

Scenarios
---------

You can upgrade the minor version of your DB instance to improve performance, optimize functions, and fix bugs.

Upgrade Scenarios
-----------------

.. table:: **Table 1** Upgrade scenarios

   +-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | Upgrade Information   | Upgrade Scenario                                                                                                                                                                                                                                                           | Description                                                                                                                                                                                                                                                                       |
   +=======================+============================================================================================================================================================================================================================================================================+===================================================================================================================================================================================================================================================================================+
   | Kernel version        | There are three scenarios for upgrading a minor version based on different kernel versions:                                                                                                                                                                                | -  If the kernel version is 2.0.51.240305 or earlier, the upgrade involves changes to the underlying data dictionary and may take a long time.                                                                                                                                    |
   |                       |                                                                                                                                                                                                                                                                            | -  For scenario 2, binlog needs to be enabled before the upgrade. Ensure that the value of **rds_global_sql_log_bin** is **ON**, the value of **binlog_expire_logs_seconds** is at least **86400**, and the value of **default_collation_for_utf8mb4** is **utf8mb4_0900_ai_ci**. |
   |                       | -  Scenario 1: If the instance's kernel version is below 2.0.51.240305, it will be upgraded to 2.0.51.240305 first, followed by a minor version pre-upgrade and then a minor version upgrade.                                                                              |                                                                                                                                                                                                                                                                                   |
   |                       | -  Scenario 2: If the instance's kernel version is 2.0.51.240305, it will undergo a minor version pre-upgrade first. After that, you need to click **Upgrade** again to start a minor version upgrade. **The following operations use this upgrade method as an example.** |                                                                                                                                                                                                                                                                                   |
   |                       | -  Scenario 3: If the instance's kernel version is above 2.0.51.240305, clicking **Upgrade** will directly trigger a minor version upgrade.                                                                                                                                |                                                                                                                                                                                                                                                                                   |
   +-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | Upgrade time          | There are two ways to upgrade a minor version based on different upgrade times.                                                                                                                                                                                            | If the kernel version of your instance has potential risks or major defects, has expired, or has been brought offline, the system will notify you by SMS message or email and deliver an upgrade task during the maintenance window.                                              |
   |                       |                                                                                                                                                                                                                                                                            |                                                                                                                                                                                                                                                                                   |
   |                       | -  Upon submission: The system upgrades the minor version immediately after your manual submission of the upgrade request on the **Basic Information** page of the instance.                                                                                               |                                                                                                                                                                                                                                                                                   |
   |                       | -  In maintenance window: The system upgrades the minor version during the maintenance window you have specified.                                                                                                                                                          |                                                                                                                                                                                                                                                                                   |
   +-----------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

Constraints
-----------

.. table:: **Table 2** Constraints

   +-----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | Phase                             | Constraint                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
   +===================================+========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================+
   | Before the upgrade                | -  To upgrade the kernel version from 2.0.51.240305 to 2.0.54.240600 or later, ensure that the value of **rds_global_sql_log_bin** is **ON** and the value of **binlog_expire_logs_seconds** is at least **86400**. For details about how to set these parameters, see :ref:`Modifying a Parameter Template <gaussdb_08_0112>`.                                                                                                                                                        |
   |                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
   |                                   | -  If the **rds_global_sql_log_bin** parameter was recently set to **ON**, you need to connect to the database and run the following command to check whether binlog is enabled for all threads.                                                                                                                                                                                                                                                                                       |
   |                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
   |                                   |    .. code-block::                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
   |                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
   |                                   |       select @@session.rds_sql_log_bin_inconsistent_count;                                                                                                                                                                                                                                                                                                                                                                                                                             |
   +-----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | During the upgrade                | -  Scenario 1 or 3: If the primary node and read replicas of an instance are deployed in the same AZ, a minor version upgrade will trigger a failover. If they are in different AZs, a minor version upgrade will trigger two failovers. A failover means that the system fails over to a read replica in case the primary node is unavailable.                                                                                                                                        |
   |                                   | -  Scenario 1 or 3: The upgrade will cause the instance to reboot and briefly interrupt workloads for about 30 to 90 seconds. To minimize the impact of the upgrade, perform the upgrade during off-peak hours, or ensure that your applications support automatic reconnection.                                                                                                                                                                                                       |
   |                                   | -  Scenario 2: During the minor version pre-upgrade, the instance will not reboot, which means workloads will not be affected.                                                                                                                                                                                                                                                                                                                                                         |
   |                                   | -  Scenario 2: The minor version upgrade will cause the instance to reboot, so workloads will be interrupted. The upgrade takes 15 to 20 minutes, and workloads are intermittently interrupted for 1 to 2 minutes. To minimize the impact, perform the upgrade during off-peak hours.                                                                                                                                                                                                  |
   |                                   | -  If an instance contains a large number of table partitions (more than 1 million), it may take more than 2 hours to reboot the instance.                                                                                                                                                                                                                                                                                                                                             |
   |                                   | -  When you upgrade the minor version of an instance, minor versions of read replicas (if any) will also be upgraded. During the upgrade, the read replicas will reboot. To minimize the impact, perform the upgrade during off-peak hours. Minor versions of read replicas cannot be upgraded separately. Once you upgrade the minor version, the instance will be upgraded to the latest minor version. A minor version upgrade cannot be rolled back after the upgrade is complete. |
   |                                   | -  DDL operations on events, such as CREATE EVENT, DROP EVENT, and ALTER EVENT, are not allowed during a minor version upgrade.                                                                                                                                                                                                                                                                                                                                                        |
   |                                   | -  If the message "Upgrade failed. Reduce the service load of the instance and click Retry" is displayed on the console, the upgrade fails due to heavy service load. Reduce the service load or retry the upgrade during off-peak hours.                                                                                                                                                                                                                                              |
   +-----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | After the upgrade                 | -  Scenario 2: If the upgrade fails, the instance will be rolled back to a previous version and its data will be restored to a new instance named *original_instance_name*\ **\_copy**. The original instance will become unavailable after the rollback, and the new instance will start to incur charges once the original instance is deleted.                                                                                                                                      |
   |                                   | -  Data cannot be restored to a point in time when a data dictionary upgrade was in progress. By default, the system searches for the most recent available point in time instead.                                                                                                                                                                                                                                                                                                     |
   |                                   | -  During the period between a data dictionary upgrade and the next full backup, data of the instance cannot be restored to the original instance or an existing instance.                                                                                                                                                                                                                                                                                                             |
   |                                   | -  When restoring backups, ensure that the data dictionary version of the target instance is the same as that of the source instance.                                                                                                                                                                                                                                                                                                                                                  |
   +-----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

Upgrading the Minor Version of a Single DB Instance
---------------------------------------------------

#. Log in to the management console.

#. Click |image1| in the upper left corner and select a region and a project.

#. Click **Service List**. Under **Databases**, click **TaurusDB**.

#. On the **Instances** page, click the instance name to go to the **Basic Information** page.

#. In the **DB Instance Information** area, click **Upgrade** in the **Kernel Version** field.

   Alternatively, go to the **Instances** page and click **Upgrade** in the **DB Engine Version** column.

#. In the displayed dialog box, set **Scheduled Time** and click **OK**.

   -  **Upon submission**: The system upgrades the minor version immediately after your submission of the upgrade request. On the **Task Center** page, click **Instant Tasks** and view the task progress.
   -  **In maintenance window**: The system upgrades the minor version during the maintenance window you have specified. After the operation is complete, go to the **Task Center** page, click **Scheduled Tasks**, and view the upgrade task details.

#. The system will automatically conduct a pre-upgrade check.

   In the displayed dialog box, read the message carefully and click **OK** to proceed with the upgrade.

#. After the pre-upgrade is complete, the instance status becomes **Pre-upgrade completed**, which means no other operations are allowed. On the **Basic Information** page, click **Upgrade** in the **Kernel Version** field again.

#. In the displayed dialog box, click **OK**. The system will automatically conduct a pre-upgrade check.

#. Confirm the check results and click **OK**.

#. After the upgrade is complete, the instance status becomes **Kernel version upgrade to be confirmed**, which means no other operations are allowed. To make the instance available again, go to the **Basic Information** page and click **Apply Upgrade** in the **Kernel Version** field.

Upgrading the Minor Versions of Multiple DB Instances at Once
-------------------------------------------------------------

#. Log in to the management console.
#. Click |image2| in the upper left corner and select a region and a project.
#. Click **Service List**. Under **Databases**, click **TaurusDB**.
#. On the **Instances** page, select the desired DB instances and click **Upgrade** in the upper left corner of the list.

   .. important::

      A maximum of 100 DB instances can be selected at once.

#. In the displayed dialog box, confirm the information about the DB instances to be upgraded and set **Scheduled Time**.

   -  **Upon submission**: The system upgrades the minor version immediately after your submission of the upgrade request. On the **Task Center** page, click **Instant Tasks** and view the task progress.
   -  **In maintenance window**: The system upgrades the minor version during the maintenance window you have specified. After the operation is complete, go to the **Task Center** page, click **Scheduled Tasks**, and view the upgrade task details.

#. Confirm the information, enter **YES** in the text box as prompted, and click **OK**.

   .. caution::

      -  Wait for 2 to 5 minutes and check whether the upgrade has been started for the DB instance. If the upgrade has not been started, check whether the value of **rds_global_sql_log_bin** is **ON** and the value of **binlog_expire_logs_seconds** is at least **86400**. If the parameters are not correctly configured, the upgrade cannot be performed.
      -  If the parameters are correctly configured but the upgrade has not started, it could be due to that the value of **rds_sql_log_bin_inconsistent_count** is not **0**. Wait until this value becomes **0** before proceeding with the upgrade.

.. |image1| image:: /_static/images/en-us_image_0000001352219100.png
.. |image2| image:: /_static/images/en-us_image_0000001352219100.png
